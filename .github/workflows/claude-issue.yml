name: 'Issue Triage (BWSM + Tools)'

on:
  issues:
    types: [opened]
  workflow_call:
    # å…è®¸è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨
    secrets:
      BWS_ACCESS_TOKEN:
        description: 'Bitwarden Secrets Manager è®¿é—®ä»¤ç‰Œ'
        required: true

# è®¾ç½® BWSM è®¿é—®ä»¤ç‰Œ
# å½“ä½œä¸ºå¯é‡ç”¨å·¥ä½œæµè¢«è°ƒç”¨æ—¶ï¼Œä½¿ç”¨ä¼ å…¥çš„ secretï¼›ç›´æ¥è§¦å‘æ—¶ä½¿ç”¨å½“å‰ä»“åº“çš„ secret
env:
  BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
  BWS_CONFIG_UUID: '02385068-1083-4e67-bb1d-b39501326d1c'

jobs:
  triage:
    runs-on: self-hosted
    
    permissions:
      issues: write
      id-token: write

    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆClaude Code Action éœ€è¦ git ä»“åº“ä¸Šä¸‹æ–‡ï¼‰
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. ä» BWSM æ‹‰å– YML é…ç½®æ–‡ä»¶
      # ç¡®ä¿ runner å·²å®‰è£… bws, jq, yq
      - name: âš™ï¸ ä» Bitwarden æ‹‰å– YML é…ç½®æ–‡ä»¶
        shell: bash
        run: |
          echo "=== æ­£åœ¨ä» Bitwarden æ‹‰å– YML é…ç½®... ==="
          CONFIG_YML_CONTENT=$(bws secret get $BWS_CONFIG_UUID | jq -r .value)

          if [ -z "$CONFIG_YML_CONTENT" ]; then
            echo "::error:: æ— æ³•ä» Bitwarden æ‹‰å–é…ç½®ã€‚è¯·æ£€æŸ¥ UUID å’Œè®¿é—®ä»¤ç‰Œã€‚"
            exit 1
          fi
          
          echo "$CONFIG_YML_CONTENT" > config.yml
          echo "::add-mask::$CONFIG_YML_CONTENT"
          echo "YML é…ç½®æ–‡ä»¶å·²æˆåŠŸæ‹‰å–å¹¶ä¿å­˜åˆ° config.ymlã€‚"

      # 3. è§£æä¸­è½¬æœåŠ¡é…ç½®
      - name: âš™ï¸ è§£æä¸­è½¬æœåŠ¡é…ç½®
        id: set_router_config
        shell: bash
        run: |
          echo "=== æ­£åœ¨ä» config.yml è¯»å–ä¸­è½¬æœåŠ¡é…ç½®... ==="
          # è¯»å–ä¸­è½¬æœåŠ¡çš„é…ç½®ï¼ˆAPI key, base URL, modelï¼‰
          ANTHROPIC_API_KEY=$(yq e -r '.router.api_key' config.yml)
          ANTHROPIC_BASE_URL=$(yq e -r '.router.base_url' config.yml)
          ANTHROPIC_MODEL=$(yq e -r '.router.model' config.yml)
          
          echo "anthropic_api_key=$ANTHROPIC_API_KEY" >> $GITHUB_OUTPUT
          echo "anthropic_base_url=$ANTHROPIC_BASE_URL" >> $GITHUB_OUTPUT
          echo "anthropic_model=$ANTHROPIC_MODEL" >> $GITHUB_OUTPUT
          
          echo "::add-mask::$ANTHROPIC_API_KEY"
          echo "ä¸­è½¬æœåŠ¡é…ç½®å·²è¯»å–ã€‚"

      # 4. è¿è¡Œ Claude Code Action (é€šè¿‡ä¸­è½¬æœåŠ¡)
      - name: ğŸ¤– è¿è¡Œ Claude Code Action (å¸¦å·¥å…·)
        id: claude
        uses: anthropics/claude-code-action@beta
        env:
          # ä½¿ç”¨ä¸­è½¬æœåŠ¡
          ANTHROPIC_BASE_URL: ${{ steps.set_router_config.outputs.anthropic_base_url }}
          ANTHROPIC_MODEL: ${{ steps.set_router_config.outputs.anthropic_model }}
          API_TIMEOUT_MS: 3000000
          # å¿…é¡»æä¾› GITHUB_TOKEN æ‰èƒ½è®© gh å‘½ä»¤å·¥ä½œ
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
        with:
          # ä½¿ç”¨ä¸­è½¬æœåŠ¡æ—¶ï¼ŒAPI key å¯ä»¥æ˜¯ä»»æ„å­—ç¬¦ä¸²
          anthropic_api_key: ${{ steps.set_router_config.outputs.anthropic_api_key }}
          
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            TITLE: ${{ github.event.issue.title }}
            BODY: ${{ github.event.issue.body }}
            AUTHOR: ${{ github.event.issue.user.login }}

            Analyze this new issue and:
            1. Determine if it's a bug report, feature request, or question
            2. Assess priority (critical, high, medium, low)
            3. Suggest appropriate labels (e.g., 'bug', 'feature', 'question', 'priority:high')
            4. Check if it duplicates existing issues using 'gh search issues'.

            Based on your analysis:
            1. Add the appropriate labels using: `gh issue edit [number] --add-label "label1,label2"`
            2. If it is a duplicate, post a comment using: `gh issue comment [number] --body "This looks like a duplicate of #[original_issue_number]."`

          claude_args: |
            --allowedTools "Bash(gh issue:edit),Bash(gh issue:comment),Bash(gh search:issues)"
      
      # 5. æ¸…ç†ä¸´æ—¶é…ç½®æ–‡ä»¶
      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶é…ç½®
        if: always()
        shell: bash
        run: |
          echo "æ­£åœ¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶..."
          rm -f config.yml