name: 'Issue Triage (BWSM + Tools)'

on:
  issues:
    types: [opened]
  workflow_call:
    # å…è®¸è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨
    secrets:
      BWS_ACCESS_TOKEN:
        description: 'Bitwarden Secrets Manager è®¿é—®ä»¤ç‰Œ'
        required: true

# 1. è®¾ç½® BWSM è®¿é—®ä»¤ç‰Œ (æ¥è‡ª Secrets)
# å½“ä½œä¸ºå¯é‡ç”¨å·¥ä½œæµè¢«è°ƒç”¨æ—¶ï¼Œä½¿ç”¨ä¼ å…¥çš„ secretï¼›ç›´æ¥è§¦å‘æ—¶ä½¿ç”¨å½“å‰ä»“åº“çš„ secret
env:
  BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
  # !! æ›¿æ¢ä¸ºæ‚¨å­˜å‚¨ Claude YML é…ç½®çš„ UUID !!
  BWS_CONFIG_UUID: '02385068-1083-4e67-bb1d-b39501326d1c'

jobs:
  triage:
    runs-on: self-hosted
    
    # 2. æƒé™ï¼šå¿…é¡»æˆäºˆ "issues: write" æƒé™ï¼Œgh å‘½ä»¤æ‰èƒ½ç”Ÿæ•ˆ
    # åŒæ—¶éœ€è¦ "id-token: write" æƒé™ï¼Œä»¥ä¾¿ Claude Code Action è·å– OIDC token
    permissions:
      issues: write
      id-token: write

    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆClaude Code Action éœ€è¦ git ä»“åº“ä¸Šä¸‹æ–‡ï¼‰
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. ä» BWSM æ‹‰å– YML é…ç½®æ–‡ä»¶ (æ¥è‡ªæ‚¨çš„ deploy-server.yml)
      # ç¡®ä¿æ‚¨çš„ runner å·²å®‰è£… bws, jq, yq
      - name: âš™ï¸ ä» Bitwarden æ‹‰å– YML é…ç½®æ–‡ä»¶
        shell: bash
        run: |
          echo "=== æ­£åœ¨ä» Bitwarden æ‹‰å– YML é…ç½®... ==="
          CONFIG_YML_CONTENT=$(bws secret get $BWS_CONFIG_UUID | jq -r .value)

          if [ -z "$CONFIG_YML_CONTENT" ]; then
            echo "::error:: æ— æ³•ä» Bitwarden æ‹‰å–é…ç½®ã€‚è¯·æ£€æŸ¥ UUID å’Œè®¿é—®ä»¤ç‰Œã€‚"
            exit 1
          fi
          
          echo "$CONFIG_YML_CONTENT" > config.yml
          echo "::add-mask::$CONFIG_YML_CONTENT"
          echo "YML é…ç½®æ–‡ä»¶å·²æˆåŠŸæ‹‰å–å¹¶ä¿å­˜åˆ° config.ymlã€‚"

      # 3. è§£æé…ç½® (ä» yml ä¸­è¯»å–ä¸­è½¬æœåŠ¡çš„é…ç½®)
      - name: âš™ï¸ è§£æä¸­è½¬æœåŠ¡é…ç½®
        id: set_router_config
        shell: bash
        run: |
          echo "=== æ­£åœ¨ä» config.yml è¯»å–ä¸­è½¬æœåŠ¡é…ç½®... ==="
          # è¯»å–ä¸­è½¬æœåŠ¡çš„é…ç½®ï¼ˆAPI key, base URL, modelï¼‰
          ANTHROPIC_API_KEY=$(yq e -r '.router.api_key' config.yml)
          ANTHROPIC_BASE_URL=$(yq e -r '.router.base_url' config.yml)
          ANTHROPIC_MODEL=$(yq e -r '.router.model' config.yml)
          
          echo "anthropic_api_key=$ANTHROPIC_API_KEY" >> $GITHUB_OUTPUT
          echo "anthropic_base_url=$ANTHROPIC_BASE_URL" >> $GITHUB_OUTPUT
          echo "anthropic_model=$ANTHROPIC_MODEL" >> $GITHUB_OUTPUT
          
          echo "::add-mask::$ANTHROPIC_API_KEY"
          echo "ä¸­è½¬æœåŠ¡é…ç½®å·²è¯»å–ã€‚"

      # 5. å‡†å¤‡ç¯å¢ƒå¹¶å¯åŠ¨ Claude Code Router ä¸­è½¬æœåŠ¡
      # - name: ğŸš€ å‡†å¤‡ç¯å¢ƒå¹¶å¯åŠ¨ä¸­è½¬æœåŠ¡
      #   shell: bash
      #   run: |
      #     echo "=== æ­£åœ¨å®‰è£… bun å¹¶å¯åŠ¨ Claude Code Router... ==="
      #     # å®‰è£… bunï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
      #     if ! command -v bun &> /dev/null; then
      #       curl -fsSL https://bun.sh/install | bash
      #       export PATH="$HOME/.bun/bin:$PATH"
      #     fi
          
      #     # åˆ›å»ºé…ç½®ç›®å½•
      #     mkdir -p $HOME/.claude-code-router
          
      #     # åˆ›å»º router é…ç½®æ–‡ä»¶
      #     cat << EOF > $HOME/.claude-code-router/config.json
      #     {
      #       "log": true,
      #       "NON_INTERACTIVE_MODE": true,
      #       "OPENAI_API_KEY": "${{ steps.set_router_config.outputs.openai_api_key }}",
      #       "OPENAI_BASE_URL": "${{ steps.set_router_config.outputs.openai_base_url }}",
      #       "OPENAI_MODEL": "${{ steps.set_router_config.outputs.openai_model }}"
      #     }
      #     EOF
          
      #     echo "::add-mask::${{ steps.set_router_config.outputs.openai_api_key }}"
          
      #     # å¯åŠ¨ router æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
      #     # ç¡®ä¿ bun åœ¨ PATH ä¸­
      #     export PATH="$HOME/.bun/bin:$PATH"
      #     nohup bunx @musistudio/claude-code-router@1.0.8 start > /tmp/claude-router.log 2>&1 &
      #     ROUTER_PID=$!
      #     echo "ROUTER_PID=$ROUTER_PID" >> $GITHUB_ENV
          
      #     # ç­‰å¾…æœåŠ¡å¯åŠ¨
      #     echo "ç­‰å¾… router æœåŠ¡å¯åŠ¨..."
      #     sleep 5
          
      #     # æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
      #     if ! ps -p $ROUTER_PID > /dev/null; then
      #       echo "::error::Router æœåŠ¡å¯åŠ¨å¤±è´¥"
      #       cat /tmp/claude-router.log
      #       exit 1
      #     fi
          
      #     echo "Router æœåŠ¡å·²å¯åŠ¨ (PID: $ROUTER_PID)"

      # 6. è¿è¡Œ Claude Code Action (é€šè¿‡ä¸­è½¬æœåŠ¡)
      - name: ğŸ¤– è¿è¡Œ Claude Code Action (å¸¦å·¥å…·)
        id: claude
        uses: anthropics/claude-code-action@beta
        env:
          # ä½¿ç”¨æœ¬åœ°ä¸­è½¬æœåŠ¡
          ANTHROPIC_BASE_URL: ${{ steps.set_router_config.outputs.anthropic_base_url }}
          ANTHROPIC_MODEL: ${{ steps.set_router_config.outputs.anthropic_model }}
          API_TIMEOUT_MS: 3000000


          # å¿…é¡»æä¾› GITHUB_TOKEN æ‰èƒ½è®© gh å‘½ä»¤å·¥ä½œ
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
        with:
          # ä½¿ç”¨ä¸­è½¬æœåŠ¡æ—¶ï¼ŒAPI key å¯ä»¥æ˜¯ä»»æ„å­—ç¬¦ä¸²
          anthropic_api_key: ${{ steps.set_router_config.outputs.anthropic_api_key }}
          
          # (å…³é”®: ä½¿ç”¨æ‚¨æä¾›çš„æ–° prompt ç»“æ„)
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            TITLE: ${{ github.event.issue.title }}
            BODY: ${{ github.event.issue.body }}
            AUTHOR: ${{ github.event.issue.user.login }}

            Analyze this new issue and:
            1. Determine if it's a bug report, feature request, or question
            2. Assess priority (critical, high, medium, low)
            3. Suggest appropriate labels (e.g., 'bug', 'feature', 'question', 'priority:high')
            4. Check if it duplicates existing issues using 'gh search issues'.

            Based on your analysis:
            1. Add the appropriate labels using: `gh issue edit [number] --add-label "label1,label2"`
            2. If it is a duplicate, post a comment using: `gh issue comment [number] --body "This looks like a duplicate of #[original_issue_number]."`

          # (å…³é”®: æˆæƒ Claude ä½¿ç”¨ gh å‘½ä»¤)
          # (æˆ‘å·²æ ¹æ®æ‚¨çš„ prompt æ‰©å±•äº†æˆæƒ, ç¡®ä¿ comment å’Œ search ä¹Ÿèƒ½ç”¨)
          claude_args: |
            --allowedTools "Bash(gh issue:edit),Bash(gh issue:comment),Bash(gh search:issues)"
      
      # 7. æ¸…ç†ä¸´æ—¶é…ç½®å’Œåœæ­¢ä¸­è½¬æœåŠ¡
      - name: ğŸ§¹ æ¸…ç†ä¸´æ—¶é…ç½®å’Œåœæ­¢ä¸­è½¬æœåŠ¡
        if: always() # æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½æ‰§è¡Œ
        env:
          ROUTER_PID: ${{ env.ROUTER_PID }}
        shell: bash
        run: |
          echo "æ­£åœ¨åœæ­¢ router æœåŠ¡..."
          if [ ! -z "$ROUTER_PID" ]; then
            kill $ROUTER_PID 2>/dev/null || true
          fi
          # ç¡®ä¿æ‰€æœ‰ router è¿›ç¨‹éƒ½è¢«åœæ­¢
          pkill -f "claude-code-router" 2>/dev/null || true
          
          echo "æ­£åœ¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶..."
          rm -f config.yml
          rm -f /tmp/claude-router.log