name: 服务部署 (YML 配置版)

on:
  workflow_call:
    inputs:
      image-name:
        description: "The name of the docker image (e.g., backend_achievement)"
        required: true
        type: string

jobs:
  deploy:
    runs-on: Linux

    # 1. 注入 BWSM 访问令牌和 YML 配置的 UUID
    env:
      BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
      BWS_CONFIG_UUID: e4311e93-a592-47bc-aff3-b395012d4003

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      # 2. 从 BWSM 拉取 YML 配置文件
      - name: ⚙️ 从 Bitwarden 拉取 YML 配置文件
        shell: bash
        run: |
          echo "=== 正在从 Bitwarden 拉取 YML 配置... ==="
          # 假设 bws 和 jq 已安装在 runner 上
          CONFIG_YML_CONTENT=$(bws secret get $BWS_CONFIG_UUID | jq -r .value)

          if [ -z "$CONFIG_YML_CONTENT" ]; then
            echo "::error:: 无法从 Bitwarden 拉取配置。请检查 UUID 和访问令牌。"
            exit 1
          fi

          # 将 YML 内容写入一个临时文件，供后续步骤读取
          echo "$CONFIG_YML_CONTENT" > config.yml

          # 掩码整个文件内容，防止敏感信息泄露到日志
          echo "::add-mask::$CONFIG_YML_CONTENT"
          
          echo "YML 配置文件已成功拉取并保存到 config.yml。"

      # 3. 登录 Docker 仓库
      - name: 登录 Docker 仓库
        shell: bash
        run: |
          echo "=== 正在从 config.yml 读取 Docker 配置... ==="
          # 假设 yq 已安装在 runner 上
          DOMAIN=$(yq e -r '.docker_registry.domain' config.yml)
          USERNAME=$(yq e -r '.docker_registry.username' config.yml)
          PASSWORD=$(yq e -r '.docker_registry.password' config.yml)

          # 掩码密码
          echo "::add-mask::$PASSWORD"

          echo "正在登录 $DOMAIN (作为 $USERNAME)..."
          echo "$PASSWORD" | docker login $DOMAIN -u $USERNAME --password-stdin
          echo "登录成功。"

      # 4. 构建和推送 Docker 镜像
      - name: 构建和推送 Docker 镜像
        shell: bash
        run: |
          echo "=== 正在从 config.yml 读取 Docker 域名... ==="
          DOMAIN=$(yq e -r '.docker_registry.domain' config.yml)
          
          IMAGE_TAG="$DOMAIN/catvote/${{ inputs.image-name }}:latest"
          
          echo "开始构建镜像: $IMAGE_TAG"
          docker build -t $IMAGE_TAG .
          echo "=== 镜像构建完成 ==="
          
          echo "开始推送镜像: $IMAGE_TAG"
          docker push $IMAGE_TAG
          echo "镜像推送完成: $IMAGE_TAG"

      # 5. 触发服务器更新 (动态 YML 列表版)
      - name: 触发服务器更新
        shell: bash
        run: |
          echo "=== 正在从 config.yml 读取部署配置... ==="
          
          # 1. 获取部署令牌
          TOKEN=$(yq e -r '.deployment.token' config.yml)
          echo "::add-mask::$TOKEN"

          echo "开始触发服务器更新..."

          # 2. 使用 yq 循环遍历 YML 中的 'servers' 数组
          yq e '.deployment.servers[] | .name + "|" + .url' config.yml | while IFS='|' read -r SERVER_NAME SERVER_URL
          do
            # xargs 用于去除 yq 输出中可能带有的前后空格
            TRIMMED_NAME=$(echo "$SERVER_NAME" | xargs)
            TRIMMED_URL=$(echo "$SERVER_URL" | xargs)

            if [ -n "$TRIMMED_NAME" ] && [ -n "$TRIMMED_URL" ]; then
              # 3. 打印友好的日志
              echo "正在向 $TRIMMED_NAME ($TRIMMED_URL) 发送更新请求..."
              
              # 4. 执行 Curl
              curl -fsS -H "Authorization: Bearer $TOKEN" "$TRIMMED_URL"
              
              echo "请求 $TRIMMED_NAME 已发送。"
            fi
          done
          
          echo "所有服务器更新触发完成"

      # 6. 清理临时配置文件
      - name: 清理临时配置
        if: always() # 无论成功或失败都执行
        run: |
          echo "正在删除 config.yml..."
          rm -f config.yml