name: 服务部署

on:
  workflow_call:
    inputs:
      image-name:
        description: "The name of the docker image (e.g., backend_achievement)"
        required: true
        type: string

    secrets:
      REGISTRY_PASSWORD:
        required: true
      DEPLOY_TOKEN:
        required: true

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 登录 Docker 仓库
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login reg.eveonecat.cn -u catvote --password-stdin

      - name: 构建和推送 Docker 镜像
        run: |
          IMAGE_TAG="reg.eveonecat.cn/catvote/${{ inputs.image-name }}:latest"

          docker build -t $IMAGE_TAG .
          echo "=== 镜像构建完成 ==="
          docker images $IMAGE_TAG --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
          IMAGE_SIZE=$(docker images $IMAGE_TAG --format "{{.Size}}")
          echo "镜像大小: $IMAGE_SIZE"
          docker push $IMAGE_TAG
          echo "镜像推送完成: $IMAGE_TAG"

      - name: 触发服务器更新
        run: |
          echo "开始触发服务器更新..."
          curl -H "Authorization: Bearer ${{ secrets.DEPLOY_TOKEN }}" http://110.42.32.187:9090/v1/update
          echo "服务器 110.42.32.187 更新请求已发送"
          curl -H "Authorization: Bearer ${{ secrets.DEPLOY_TOKEN }}" http://110.42.32.184:9090/v1/update
          echo "服务器 110.42.32.184 更新请求已发送"
          curl -H "Authorization: Bearer ${{ secrets.DEPLOY_TOKEN }}" http://110.42.32.145:9090/v1/update
          echo "服务器 110.42.32.145 更新请求已发送"
          echo "所有服务器更新触发完成"
